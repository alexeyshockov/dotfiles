#!/usr/local/bin/bash

set -e
#set -x

MAIN_BRANCH=$1
[ -z "$MAIN_BRANCH" ] && echo "Please give the main branch name" && exit 1

echo "Cleaning up all merged to '$MAIN_BRANCH' branch..."

git fetch --all --quiet

git remote prune origin

echo "Branches to delete:"
git branch -r --merged origin/$MAIN_BRANCH | grep origin | grep -v '\*\|master\|main\|develop' | sed 's/origin\///'
echo "Cleaning up..."

git branch -r --merged origin/$MAIN_BRANCH | grep origin | grep -v '\*\|master\|main\|develop' | sed 's/origin\///' | xargs -P 5 -n 1 git push --delete origin
